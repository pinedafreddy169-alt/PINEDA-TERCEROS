<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Control de Personal de Terceros</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#151923;--muted:#8a90a2;--text:#e8ecf1;
      --accent:#5ea1ff;--danger:#ff5e7a;--border:#232838
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{font-size:1.9rem;margin:0 0 6px}
    .lead{color:var(--muted);margin:0 0 16px}
    .card{background:var(--panel);border:1px solid var(--border);
      border-radius:14px;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;
      background:#111524;color:var(--muted);cursor:pointer}
    .tab.active{background:var(--accent);color:#07111f;border-color:transparent;
      font-weight:700}
    label{font-size:.9rem;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);
      background:#0c0f17;color:var(--text)
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row{margin-bottom:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border:0;border-radius:12px;cursor:pointer;
      font-weight:700}
    .btn{background:#1b2233;color:var(--text);border:1px solid var(--border)}
    .primary{background:var(--accent);color:#051226}
    .danger{background:var(--danger);color:#22070c}
    .muted{color:var(--muted)}
    .small{font-size:.85rem}
    .ok{color:#2bd27f}
    .error{color:var(--danger)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:6px 8px;font-size:.9rem}
    th{background:#101525;color:var(--muted);text-align:left}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;
      font-size:.8rem;border:1px solid var(--border);background:#101525;
      color:var(--muted)}
    .topbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      justify-content:space-between;margin-bottom:12px}
    @media(max-width:800px){.grid2,.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Control de Personal de Terceros</h1>
      <p class="lead">Registra fecha, finca, lote y cantidad de personal por tercero.</p>
    </div>
    <div>
      <span class="badge" id="appVersion"></span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="registro">Registrar</button>
    <button class="tab" data-tab="borradores">Borradores</button>
    <button class="tab" data-tab="config">Fincas &amp; Lotes</button>
    <button class="tab" data-tab="sincronizar">Sincronizar</button>
  </div>

  <!-- REGISTRO -->
  <section id="registro" class="card">
    <div class="grid3 row">
      <div>
        <label>Fecha</label>
        <input type="date" id="r_fecha">
      </div>
      <div>
        <label>Finca</label>
        <select id="r_finca"></select>
      </div>
      <div>
        <label>Lote</label>
        <select id="r_lote"></select>
      </div>
    </div>

    <div class="grid2 row">
      <div>
        <label>Actividad</label>
        <input type="text" id="r_actividad" placeholder="Ej. Chapea, siembra, cosecha…">
      </div>
      <div>
        <label>Cantidad de personal</label>
        <input type="number" id="r_cantidad" min="0" inputmode="numeric">
      </div>
    </div>

    <div class="grid2 row">
      <div>
        <label>Tercero</label>
        <select id="r_tercero"></select>
      </div>
      <div>
        <label>Encargado de conteo</label>
        <select id="r_encargado"></select>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="btnBorrador">Guardar borrador</button>
      <button class="btn" id="btnEnviar" data-label="Enviar a Excel">Enviar a Excel</button>
      <button class="btn" id="btnLimpiar">Limpiar</button>
      <span id="estadoEnvio" class="muted small"></span>
    </div>
  </section>

  <!-- BORRADORES -->
  <section id="borradores" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnSyncBorradores">Sincronizar todos</button>
      <span id="estadoBor" class="muted small"></span>
    </div>
    <div id="tablaBor" class="row"></div>
  </section>

  <!-- CONFIG FINCAS/LOTES -->
  <section id="config" class="card" hidden>
    <div id="f_lock" class="row">
      <div class="grid3">
        <div>
          <label>Estado</label>
          <input id="admin_status" readonly>
        </div>
        <div>
          <label>Contraseña admin</label>
          <input type="password" id="admin_pass" placeholder="admi12345">
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="btnUnlock">Desbloquear</button>
          <button class="danger" id="btnLock" hidden>Bloquear</button>
        </div>
      </div>
      <p class="muted small">Solo el administrador puede editar las listas de fincas y lotes.</p>
    </div>

    <div id="f_admin" hidden>
      <div class="row grid2">
        <div>
          <label>Nueva finca</label>
          <input type="text" id="f_nueva" placeholder="Ej. Buena Vista">
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="primary" id="f_add">Agregar finca</button>
        </div>
      </div>
      <div class="row grid3">
        <div>
          <label>Lote (texto)</label>
          <input type="text" id="l_nuevo" placeholder="Ej. Lote 007">
        </div>
        <div>
          <label>Asignar a finca</label>
          <select id="l_fincaSel"></select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="primary" id="l_add">Agregar lote</button>
        </div>
      </div>
    </div>

    <div id="f_lista" class="row"></div>
    <div id="l_lista" class="row"></div>
  </section>

  <!-- SINCRONIZAR -->
  <section id="sincronizar" class="card" hidden>
    <div class="actions">
      <button class="primary" id="btnEnviarPendientes">Enviar pendientes</button>
      <button class="btn" id="btnSync">Leer hoja</button>
      <span id="estadoSync" class="muted small"></span>
    </div>
    <div id="tabla" class="row"></div>
  </section>
</div>

<script>
const APP_VERSION = "2025.11.30-1";
const GAS_URL = "https://script.google.com/macros/s/AKfycbyRyk4YvdnP8aI8tn0F-TdhNTihQxzILbRvT_wV9-K0-5QolLwbdbM1SmlUPvcoIQVl/exec";
const ADMIN_PASS_NORMALIZED = "admi12345";

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function todayISO(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,10);
}

function toast(el,msg,ok=true){
  if(!el) return;
  el.textContent = msg;
  el.className = ok ? "ok small" : "error small";
  setTimeout(()=>{ el.textContent=""; el.className="muted small"; },3500);
}

function setBtnLoading(btn,loading,label){
  if(!btn) return;
  if(loading){
    btn.disabled = true;
    btn.textContent = "Enviando…";
  }else{
    btn.disabled = false;
    btn.textContent = label || btn.dataset.label || "Enviar";
  }
}

const store = {
  get(k,d){
    try{
      const v = localStorage.getItem(k);
      return v ? JSON.parse(v) : d;
    }catch{return d;}
  },
  set(k,v){
    try{
      localStorage.setItem(k,JSON.stringify(v));
      return true;
    }catch{return false;}
  }
};

function normalizePass(p){return (p||"").replace(/\s+/g,"").toLowerCase();}

/*** DATOS BASE ***/
const DEFAULTS = {
  lotesRaw:[
    {finca:"Buena Vista",lote:"Lote 001"},{finca:"Buena Vista",lote:"Lote 002"},
    {finca:"Buena Vista",lote:"Lote 003"},{finca:"Buena Vista",lote:"Lote 005"},
    {finca:"Buena Vista",lote:"Lote 007"},{finca:"Buena Vista",lote:"Lote 008"},
    {finca:"Buena Vista",lote:"Lote 009"},{finca:"Buena Vista",lote:"Lote 011"},
    {finca:"Buena Vista",lote:"Lote 014"},{finca:"Buena Vista",lote:"Lote 015"},
    {finca:"Buena Vista",lote:"Lote 016"},
    {finca:"Caño Blanco",lote:"Lote 001"},{finca:"Caño Blanco",lote:"Lote 002"},
    {finca:"Caño Blanco",lote:"Lote 003"},{finca:"Caño Blanco",lote:"Lote 004"},
    {finca:"Caño Blanco",lote:"Lote 005"},{finca:"Caño Blanco",lote:"Lote 006"},
    {finca:"Caño Blanco",lote:"Lote 007"},{finca:"Caño Blanco",lote:"Lote 008"},
    {finca:"Caño Blanco",lote:"Lote 009"},{finca:"Caño Blanco",lote:"Lote 011"},
    {finca:"Chorcha",lote:"Lote 001"},
    {finca:"Don Cuyo",lote:"Lote 001"},{finca:"Don Cuyo",lote:"Lote 002"},
    {finca:"Don Cuyo",lote:"Lote 003"},{finca:"Don Cuyo",lote:"Lote 004"},
    {finca:"Enrique",lote:"Lote 001"},{finca:"Enrique",lote:"Lote 002"},
    {finca:"Guayabito",lote:"Lote 001"},{finca:"Guayabito",lote:"Lote 002"},
    {finca:"Guayabito",lote:"Lote 003"},{finca:"Guayabito",lote:"Lote 004"},
    {finca:"Guayabito",lote:"Lote 005"},{finca:"Guayabito",lote:"Lote 006"},
    {finca:"Guayabito",lote:"Lote 011"},{finca:"Guayabito",lote:"Lote 012"},
    {finca:"Guayabito",lote:"Lote 014"},{finca:"Guayabito",lote:"Lote 015"},
    {finca:"Guayabito",lote:"Lote 017"},{finca:"Guayabito",lote:"Lote 019"},
    {finca:"Guayabito",lote:"Lote 021"},{finca:"Guayabito",lote:"Lote 022"},
    {finca:"Guayabito",lote:"Lote 027"},
    {finca:"Los Abuelos",lote:"Lote 001"},
    {finca:"Los Angeles",lote:"Lote 001"},
    {finca:"Oscar",lote:"Lote 001"},{finca:"Oscar",lote:"Lote 002"},
    {finca:"Oscar",lote:"Lote 003"},
    {finca:"Pajarilla",lote:"Lote 001"},
    {finca:"Pataste",lote:"Lote 001"},{finca:"Pataste",lote:"Lote 002"},
    {finca:"Pataste",lote:"Lote 003"},{finca:"Pataste",lote:"Lote 004"},
    {finca:"Pataste",lote:"Lote 006"},{finca:"Pataste",lote:"Lote 007"},
    {finca:"Pataste",lote:"Lote 008"},
    {finca:"Progreso",lote:"Lote 001"},{finca:"Progreso",lote:"Lote 002"},
    {finca:"Progreso",lote:"Lote 003"},{finca:"Progreso",lote:"Lote 004"},
    {finca:"Progreso",lote:"Lote 005"},
    {finca:"Rescate",lote:"Lote 001"},{finca:"Rescate",lote:"Lote 004"},
    {finca:"Rescate",lote:"Lote 005"},{finca:"Rescate",lote:"Lote 006"},
    {finca:"Rescate",lote:"Lote 007"},{finca:"Rescate",lote:"Lote 008"},
    {finca:"Rescate",lote:"Lote 013"},
    {finca:"San Luis",lote:"Lote 001"},
    {finca:"Tuto",lote:"Lote 001"}
  ]
};

const ENCARGADOS = [
  "Braulio","Victor","Juan Perez","Roberto","Jorge","Efrain",
  "Geovani Jimenez","Leandro Bustos","Vinicio Vonilla","Fabian Esquivel",
  "Adrian Cruz","Kevin Alvares","Ariel Rubi","Kennet Oporta",
  "Planta La Bruja","Planta Bajo Cero","Javier Cerdas"
];

const TERCEROS = [
  "Soluciones Agricolas",
  "Bolivar Rodrigues",
  "Derex Arrieta"
];

function dedupLotes(raw){
  const ok = (raw||[]).filter(r=>r && r.finca && r.lote);
  const map = new Map(ok.map(r=>[r.finca+"|"+r.lote,{finca:r.finca.trim(),lote:r.lote.trim()}]));
  return Array.from(map.values());
}
function safeArray(a,d){return Array.isArray(a)?a:d;}

let lotes = dedupLotes(store.get("terc_lotes",DEFAULTS.lotesRaw));
let fincas = [...new Set(lotes.map(r=>r.finca))].sort();
store.set("terc_lotes",lotes);
store.set("terc_fincas",fincas);

let borradores = safeArray(store.get("terc_borradores",[]),[]);
let pendientes = safeArray(store.get("terc_pendientes",[]),[]);
let isAdmin = !!store.get("terc_is_admin",false);

/*** TABS ***/
$$(".tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    $$(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    ["registro","borradores","config","sincronizar"].forEach(id=>{
      const sec = $("#"+id);
      if(sec) sec.hidden = (id!==btn.dataset.tab);
    });
    if(btn.dataset.tab==="borradores") renderBorradores();
    if(btn.dataset.tab==="config") updateAdminUI();
  });
});

/*** FINCAS & LOTES ***/
function buildFincaSelect(selId,defFinca){
  const s = $(selId);
  if(!s) return;
  s.innerHTML = fincas.map(f=>`<option value="${f}">${f}</option>`).join("");
  if(defFinca && fincas.includes(defFinca)) s.value = defFinca;
}

function updateLotes(fincaSel,loteSel,defLote){
  const sF = $(fincaSel), sL = $(loteSel);
  if(!sF || !sL) return;
  const arr = lotes.filter(x=>x.finca===sF.value);
  sL.innerHTML = arr.map(x=>`<option value="${x.lote}">${x.lote}</option>`).join("");
  if(defLote && arr.some(x=>x.lote===defLote)) sL.value = defLote;
}

function initFincaLote(){
  buildFincaSelect("#r_finca","Caño Blanco");
  updateLotes("#r_finca","#r_lote");
  $("#r_finca")?.addEventListener("change",()=>updateLotes("#r_finca","#r_lote"));
}

/*** ADMIN FINCAS/LOTES ***/
function setAdmin(v){
  isAdmin = !!v;
  store.set("terc_is_admin",isAdmin);
  updateAdminUI();
}

function updateAdminUI(){
  const st = $("#admin_status");
  if(st) st.value = isAdmin ? "Desbloqueado — administrador" : "Bloqueado — solo lectura";
  const box = $("#f_admin");
  const btnLock = $("#btnLock");
  if(box) box.hidden = !isAdmin;
  if(btnLock) btnLock.hidden = !isAdmin;
  renderAdminFincasLotes();
}

function renderAdminFincasLotes(){
  const sel = $("#l_fincaSel");
  if(sel) sel.innerHTML = fincas.map(f=>`<option value="${f}">${f}</option>`).join("");

  const fList = $("#f_lista");
  if(fList){
    fList.innerHTML = fincas.map((f,i)=>`
      <div class="row grid2">
        <input value="${f}" disabled>
        ${isAdmin?`<button class="danger" onclick="delFinca(${i})">Eliminar</button>`:""}
      </div>
    `).join("") || "<p class='muted small'>Sin fincas.</p>";
  }

  const lList = $("#l_lista");
  if(lList){
    let html = "";
    fincas.forEach(f=>{
      html += `<h4 style="margin:10px 0 6px">${f}</h4>`;
      const arr = lotes.filter(x=>x.finca===f);
      if(!arr.length){
        html += "<p class='muted small'>Sin lotes</p>";
      }else{
        html += "<div class='grid3'>"+
          arr.map(x=>{
            const key = x.finca+"|"+x.lote;
            return `<div class="row">
              <input value="${x.lote}" disabled>
              ${isAdmin?`<button class="danger" onclick="delLote('${key}')">Eliminar</button>`:""}
            </div>`;
          }).join("")+"</div>";
      }
    });
    lList.innerHTML = html;
  }
}

window.delLote = key=>{
  if(!isAdmin){alert("Solo administrador.");return;}
  lotes = lotes.filter(x=>x.finca+"|"+x.lote!==key);
  fincas = [...new Set(lotes.map(r=>r.finca))].sort();
  store.set("terc_lotes",lotes);
  store.set("terc_fincas",fincas);
  updateAdminUI();
  initFincaLote();
};

window.delFinca = i=>{
  if(!isAdmin){alert("Solo administrador.");return;}
  const nombre = fincas[i];
  lotes = lotes.filter(x=>x.finca!==nombre);
  fincas.splice(i,1);
  store.set("terc_lotes",lotes);
  store.set("terc_fincas",fincas);
  updateAdminUI();
  initFincaLote();
};

$("#btnUnlock")?.addEventListener("click",()=>{
  const ok = normalizePass($("#admin_pass")?.value)===ADMIN_PASS_NORMALIZED;
  if(!ok){alert("Contraseña incorrecta.");return;}
  $("#admin_pass").value="";
  setAdmin(true);
});
$("#btnLock")?.addEventListener("click",()=>setAdmin(false));

$("#f_add")?.addEventListener("click",()=>{
  if(!isAdmin){alert("Solo administrador.");return;}
  const v = ($("#f_nueva")?.value||"").trim();
  if(!v) return;
  if(!fincas.includes(v)) fincas.push(v);
  fincas.sort();
  store.set("terc_fincas",fincas);
  $("#f_nueva").value="";
  updateAdminUI();
  initFincaLote();
});

$("#l_add")?.addEventListener("click",()=>{
  if(!isAdmin){alert("Solo administrador.");return;}
  const lote = ($("#l_nuevo")?.value||"").trim();
  const finca = $("#l_fincaSel")?.value;
  if(!lote || !finca) return;
  lotes.push({finca,lote});
  const map = new Map(lotes.map(r=>[r.finca+"|"+r.lote,r]));
  lotes = Array.from(map.values());
  fincas = [...new Set(lotes.map(r=>r.finca))].sort();
  store.set("terc_lotes",lotes);
  store.set("terc_fincas",fincas);
  $("#l_nuevo").value="";
  updateAdminUI();
  initFincaLote();
});

/*** ENCARGADOS & TERCEROS ***/
function renderEncargados(){
  const sel = $("#r_encargado");
  if(!sel) return;
  sel.innerHTML = ENCARGADOS.map(n=>`<option value="${n}">${n}</option>`).join("");
}
function renderTerceros(){
  const sel = $("#r_tercero");
  if(!sel) return;
  sel.innerHTML = TERCEROS.map(n=>`<option value="${n}">${n}</option>`).join("");
}

/*** FORMULARIO PRINCIPAL ***/
function leerRegistro(){
  return{
    fecha: $("#r_fecha")?.value || todayISO(),
    finca: $("#r_finca")?.value || "",
    lote: $("#r_lote")?.value || "",
    actividad: $("#r_actividad")?.value || "",
    cantidadPersonal: Number($("#r_cantidad")?.value || 0),
    tercero: $("#r_tercero")?.value || "",
    encargadoConteo: $("#r_encargado")?.value || "",
    _ts: Date.now()
  };
}

$("#btnLimpiar")?.addEventListener("click",()=>{
  $("#r_actividad").value="";
  $("#r_cantidad").value="";
  const f = $("#r_fecha");
  if(f) f.value=todayISO();
  initFincaLote();
  renderTerceros();
  renderEncargados();
});

/*** BORRADORES ***/
let editIndex = -1;

function renderBorradores(){
  const cont = $("#tablaBor");
  if(!cont) return;
  if(!borradores.length){
    cont.innerHTML = "<p class='muted small'>No hay borradores.</p>";
    return;
  }
  const cols=[
    ["fecha","FECHA"],["finca","FINCA"],["lote","LOTE"],
    ["actividad","ACTIVIDAD"],["cantidadPersonal","CANTIDAD"],
    ["tercero","TERCERO"],["encargadoConteo","ENCARGADO"]
  ];
  let html="<table><thead><tr>"+
    cols.map(([,t])=>`<th>${t}</th>`).join("")+
    "<th>Acciones</th></tr></thead><tbody>";
  borradores.forEach((r,i)=>{
    html+="<tr>"+
      cols.map(([k])=>`<td>${(r && r[k]) ?? ""}</td>`).join("")+
      `<td>
         <button class="btn" onclick="editarBor(${i})">Cargar</button>
         <button class="danger" onclick="eliminarBor(${i})">Eliminar</button>
         <button class="primary" id="btnEnviarBor-${i}" data-label="Enviar" onclick="enviarUno(${i})">Enviar</button>
       </td></tr>`;
  });
  html+="</tbody></table>";
  cont.innerHTML=html;
}

window.editarBor = i=>{
  const r = borradores[i] || {};
  editIndex = i;
  $("#r_fecha").value = r.fecha || todayISO();
  $("#r_finca").value = r.finca || $("#r_finca").value;
  updateLotes("#r_finca","#r_lote",r.lote);
  $("#r_actividad").value = r.actividad || "";
  $("#r_cantidad").value = r.cantidadPersonal ?? r.cantidad ?? "";
  $("#r_tercero").value = r.tercero || $("#r_tercero").value;
  $("#r_encargado").value = r.encargadoConteo || r.encargado || $("#r_encargado").value;
  document.querySelector('.tab[data-tab="registro"]').click();
};

window.eliminarBor = i=>{
  borradores.splice(i,1);
  store.set("terc_borradores",borradores);
  renderBorradores();
};

const sendingRow = new Set();
let sendingAll = false;

window.enviarUno = async i=>{
  if(sendingRow.has(i)) return;
  sendingRow.add(i);
  const btn = document.getElementById(`btnEnviarBor-${i}`);
  if(btn){btn.disabled=true;btn.textContent="Enviando…";}
  const r = borradores[i];
  const ok = await enviarRegistro(r,false,$("#estadoBor"));
  if(ok){
    borradores.splice(i,1);
    store.set("terc_borradores",borradores);
    renderBorradores();
    toast($("#estadoBor"),"Borrador enviado ✅",true);
  }else{
    toast($("#estadoBor"),"Error al enviar. Quedó en pendientes.",false);
    if(btn){btn.disabled=false;btn.textContent="Enviar";}
  }
  sendingRow.delete(i);
};

$("#btnBorrador")?.addEventListener("click",()=>{
  const r = leerRegistro();
  if(editIndex>=0){borradores[editIndex]=r;editIndex=-1;}
  else borradores.push(r);
  const ok = store.set("terc_borradores",borradores);
  toast($("#estadoEnvio"),ok?"Borrador guardado ✅":"Guardado solo en esta sesión",ok);
  renderBorradores();
});

$("#btnSyncBorradores")?.addEventListener("click",async()=>{
  if(sendingAll) return;
  if(!borradores.length){toast($("#estadoBor"),"No hay borradores");return;}
  const btn=$("#btnSyncBorradores");
  sendingAll=true;
  btn.disabled=true;btn.textContent="Enviando…";
  let ok=0,fail=0,nuevos=[];
  for(const r of borradores){
    const ex = await enviarRegistro(r,false,$("#estadoBor"));
    if(ex) ok++; else{fail++;nuevos.push(r);}
  }
  borradores=nuevos;
  store.set("terc_borradores",borradores);
  renderBorradores();
  toast($("#estadoBor"),`OK ${ok} / Error ${fail}`,fail===0);
  btn.disabled=false;btn.textContent="Sincronizar todos";
  sendingAll=false;
});

/*** ENVÍO A APPS SCRIPT ***/
async function enviarRegistro(reg,showMsg=true,estadoEl){
  try{
    const body = new URLSearchParams({payload:JSON.stringify([reg])});
    const res = await fetch(GAS_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body,
      cache:"no-store"
    });
    const txt = await res.text();
    let j;
    try{ j = JSON.parse(txt); }catch{ j = {ok:res.ok}; }
    if(!j.ok) throw new Error(j.error || "Respuesta no OK");
    if(showMsg) toast(estadoEl || $("#estadoEnvio"),"Enviado ✅",true);
    return true;
  }catch(e){
    toast(estadoEl || $("#estadoEnvio"),"Sin internet. Guardado en pendientes.",false);
    pendientes.push(reg);
    store.set("terc_pendientes",pendientes);
    return false;
  }
}

/*** BOTONES PRINCIPALES ***/
let sending = false;
$("#btnEnviar")?.addEventListener("click",async()=>{
  if(sending) return;
  sending=true;
  setBtnLoading($("#btnEnviar"),true);
  const reg = leerRegistro();
  await enviarRegistro(reg,true,$("#estadoEnvio"));
  setBtnLoading($("#btnEnviar"),false,$("#btnEnviar").dataset.label);
  sending=false;
});

/*** PENDIENTES & LECTURA DE HOJA ***/
$("#btnEnviarPendientes")?.addEventListener("click",async()=>{
  const est=$("#estadoSync");
  if(!pendientes.length){toast(est,"No hay pendientes");return;}
  let ok=0,fail=0,nuevos=[];
  for(const r of pendientes){
    const ex = await enviarRegistro(r,false,est);
    if(ex) ok++; else{fail++;nuevos.push(r);}
  }
  pendientes=nuevos;
  store.set("terc_pendientes",pendientes);
  toast(est,`Pendientes OK ${ok} / Error ${fail}`,fail===0);
});

$("#btnSync")?.addEventListener("click",async()=>{
  const est=$("#estadoSync"), cont=$("#tabla");
  if(est){est.textContent="Leyendo…";est.className="muted small";}
  try{
    const res = await fetch(GAS_URL+"?action=getData",{cache:"no-store"});
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "Error");
    const headers = (j.headers && j.headers.length) ? j.headers : Object.keys(j.data[0]||{});
    let html="<table><thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+
      "</tr></thead><tbody>";
    j.data.forEach(row=>{
      html+="<tr>"+headers.map(h=>`<td>${row[h] ?? ""}</td>`).join("")+"</tr>";
    });
    html+="</tbody></table>";
    if(cont) cont.innerHTML=html;
    toast(est,`Registros: ${j.data.length}`,true);
  }catch(e){
    toast(est,String(e),false);
  }
});

/*** ERRORES GLOBALES ***/
window.onerror = (m)=>{toast($("#estadoEnvio"),"Error: "+m,false);return true;};
window.onunhandledrejection = (ev)=>{toast($("#estadoEnvio"),"Error: "+(ev.reason?.message||ev.reason),false);return true;};

/*** INICIO ***/
document.getElementById("appVersion").textContent="v"+APP_VERSION;
const f0=$("#r_fecha"); if(f0 && !f0.value) f0.value=todayISO();
renderEncargados();
renderTerceros();
initFincaLote();
updateAdminUI();
renderBorradores();
</script>
</body>
</html>
